<div class="workspace-hero">
  <div>
    <h1 class="workspace-title"><%= @workspace.name %></h1>
    <p class="workspace-meta">
      <strong>Owner:</strong> <%= @workspace.owner&.name || "Unassigned" %>
      <% if @workspace.respond_to?(:description) && @workspace.description.present? %>
        <span class="separator">•</span>
        <%= @workspace.description %>
      <% end %>
    </p>

    <% if current_user_is_owner?(@workspace) %>
      <div class="hero-actions">
        <%= link_to "View Missing Items", workspace_missing_reports_path(@workspace), class: "btn-pill" %>
        <%= link_to "Edit Workspace", edit_workspace_path(@workspace), class: "link-inline" %>
      </div>
    <% end %>
  </div>

  <% if @current_join.nil? || @current_join.role == 'user' %>
    <div class="hero-meta">
      <%= button_to (@current_join ? "Unbookmark" : "Bookmark"),
                    workspace_user_to_workspace_path(@workspace),
                    method: (@current_join ? :delete : :post),
                    class: "btn-gold",
                    data: (@current_join ? { confirm: "Remove this workspace from your bookmarks?" } : {}) %>
    </div>
  <% end %>
</div>

<% if @penalty && !current_user_is_owner?(@workspace) %>
  <div class="banner-warning">
    <div class="banner-icon">⚠️</div>
    <div>
      <p class="banner-title">Penalty Notice</p>
      <p class="banner-body">
        You are blocked from making reservations in this workspace due to a
        <%= @penalty.reason.humanize.downcase %>. You’ll regain access after
        <strong><%= @penalty.expires_at.strftime("%B %-d at %-I:%M %p") %></strong>.
      </p>
      <% if @penalty.appeal_pending? %>
        <p class="banner-subtle">Appeal submitted — waiting on owner review.</p>
      <% elsif @penalty.appeal_state == "resolved" %>
        <p class="banner-subtle success">Appeal reviewed by owner.</p>
      <% else %>
        <%= form_with url: appeal_penalty_path(@penalty), method: :post, local: true, html: { class: "appeal-form" } do %>
          <%= text_field_tag :appeal_message, nil, placeholder: "Share context (optional)", class: "form-control" %>
          <%= submit_tag "Appeal Penalty", class: "btn-ghost" %>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<hr>
<% is_owner = @current_join&.role == 'owner' %>
<% if is_owner %>
  <div class="current-activity-section">
    <h3 class="section-heading">Current Activity at <%= @tz.now.strftime("%-I:%M %p %Z") %></h3>
    <% if @current_activity.any? %>
      <table class="activity-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>User</th>
            <th>Quantity</th>
            <th>Starts</th>
            <th>Ends</th>
            <th>No Show</th>
            <th>Return Items</th>
          </tr>
        </thead>
        <tbody>
          <% @current_activity.each do |reservation| %>
            <tr>
              <td><%= reservation.item.name %></td>
              <td><%= reservation.user.name %></td>
              <td><%= reservation.quantity %></td>
              <td><%= reservation.start_time.strftime("%-I:%M %p") %></td>
              <td><%= reservation.end_time.strftime("%-I:%M %p") %></td>
              <td>
                <div class="activity-actions">
                  <% if reservation.no_show? %>
                    <%= button_to "Undo No Show",
                                  mark_no_show_reservation_path(reservation),
                                  method: :patch,
                                  class: "btn-action-revert" %>
                  <% else %>
                    <%= button_to "Mark No Show",
                                  mark_no_show_reservation_path(reservation),
                                  method: :patch,
                                  class: "btn-action-warn",
                                  data: { confirm: "Are you sure? This will mark '#{reservation.user.name}' as a 'No Show'." } %>
                  <% end %>
                </div>
              </td>
              <td>
                <div class="return-form-wrapper">
                  <%
                    total = reservation.quantity
                    returned = reservation.returned_count
                    still_missing = total - returned
                  %>

                  <% if still_missing > 0 %>
                    <%= form_with(url: return_items_reservation_path(reservation), method: :patch, class: "return-form") do |f| %>
                      <%= number_field_tag :quantity_to_return, nil,
                            placeholder: "Qty",
                            class: "return-input",
                            min: 1,
                            max: still_missing %>
                      <%= f.submit "Return", class: "btn-action-revert" %>
                    <% end %>
                  <% elsif returned > 0 %>
                    <%= form_with(url: undo_return_items_reservation_path(reservation), method: :patch, class: "return-form") do |f| %>
                      <%= number_field_tag :quantity_to_undo, nil,
                            placeholder: "Qty",
                            class: "return-input",
                            min: 1,
                            max: returned %>
                      <%= f.submit "Undo", class: "btn-action-warn" %>
                    <% end %>
                  <% end %>

                  <%# --- STATUS MESSAGE --- %>
                  <% if still_missing == 0 %>
                    <span class="status-note-complete">All items returned</span>
                  <% else %>
                    <span class="status-note">(<%= still_missing %> / <%= total %> missing)</span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No current activity in this workspace.</p>
    <% end %>
  </div>
<% end %>

<% slots = @slots %>

<style>

  /* floating tooltip for owner hover */
  #slot-tooltip {
    position: fixed;
    z-index: 9999;
    pointer-events: none;
    background: #111827;      /* gray-900 */
    color: #fff;
    font-size: 12px;
    line-height: 1.4;
    padding: 8px 10px;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,.2);
    max-width: 320px;
    display: none;
    white-space: normal;
  }
  #slot-tooltip .t-hed {
    font-weight: 600;
    margin-bottom: 4px;
    opacity: .9;
  }
  #slot-tooltip .t-body {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .legend { display:flex; gap:1.25rem; align-items:center; margin: 0.5rem 0 1rem; font-size:14px; }
  .legend .key { display:inline-flex; align-items:center; gap:0.5rem; }
  .legend .swatch { width:16px; height:16px; border-radius:3px; border:1px solid #bbb; }

  .schedule-wrapper {
    margin-top: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: auto;
    max-height: 70vh;
    max-width: 100%;
    position: relative;
  }
  .schedule-grid {
    display: grid;
    grid-template-columns:
      160px
      110px
      repeat(<%= slots.size %>, 10px);
    min-width: calc(160px + 110px + <%= slots.size %> * 10px);
  }
  .cell {
    padding: 6px;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    background: #fff;
    font-size: 13px;
    line-height: 1.25;
    box-sizing: border-box;
  }
  .cell.sticky-1 { position: sticky; left: 0; background: #fff; font-weight: 600; z-index: 3; border-right: 1px solid #e5e7eb; }
  .cell.sticky-2 { position: sticky; left: 160px; background: #fff; font-weight: 600; z-index: 3; border-right: 1px solid #e5e7eb; border-left: none; }
  .time-cell { text-align: center; font-weight: 600; background: #f9fafb; position: sticky; top: 0; z-index: 2; font-size: 12px; color: #6b7280; padding: 8px 0; }
  .corner { position: sticky; top: 0; left: 0; z-index: 4; background: #f9fafb; font-weight:700; color: #374151; }
  .corner-2 { position: sticky; top: 0; left: 160px; z-index: 4; background: #f9fafb; font-weight:700; color: #374151; }

  .slot {
    cursor: pointer;
    height: 32px;
    margin: 0;
    border-radius: 0;
    border: none;
    transition: background-color 0.1s ease;
  }

  /* meanings */
  .slot.available   { 
    background: #86efac;
    border-right: 0.5px solid #4ade80;
  } /* green-100 */
  .slot.available:hover { background: #4ade80; }
  
  .slot.unavailable { background: #f3f4f6; /* gray-100 */ 
                      background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #e5e7eb 5px, #e5e7eb 10px); }
  
  .slot.selected    { background: #3b82f6; } /* blue-500 */
  .slot.selected:hover { background: #2563eb; }
  
  .slot.outside     { background: #f9fafb; cursor: not-allowed; }

  .slot:hover { transform: none; }

  .item-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; }
  .qty-wrap { display:flex; align-items:center; gap:4px; }
  .qty-controls { display:inline-flex; flex-direction:column; gap:2px; }
  .qty-btn {
    width:24px; height:20px; line-height:18px; text-align:center;
    border:1px solid #d1d5db; border-radius:4px; background:#fff; cursor:pointer;
    user-select:none; font-size:12px;
  }
  .qty-btn:disabled { opacity: 0.45; cursor: not-allowed; }
  .qty-display { font-weight:700; min-width: 1.8rem; text-align:center; font-size:15px; }
  .qty-cap { color:#6b7280; font-size: 12px; }

  .actions-bar { margin-top: 14px; display: flex; justify-content: flex-end; }
  .btn-primary {
    background: #111827; color: #fff; border: none;
    padding: 10px 16px; font-size: 15px; border-radius: 8px; cursor: pointer;
  }
  .btn-primary:hover { filter: brightness(1.05); }

  .workspace-hero {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    padding: 18px 0 10px;
  }
  .workspace-title { margin: 0; font-size: 28px; color: #0f172a; }
  .workspace-meta { margin: 6px 0 0 0; color: #475569; font-size: 15px; }
  .hero-actions { margin-top: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .btn-pill {
    display: inline-block;
    padding: 8px 14px;
    background: #fcd34d;
    color: #92400e;
    border-radius: 999px;
    font-weight: 700;
    text-decoration: none;
    border: 1px solid #f59e0b;
  }
  .link-inline { color: #0ea5e9; text-decoration: none; font-weight: 600; }
  .link-inline:hover { text-decoration: underline; }
  .hero-meta { text-align: right; color: #6b7280; font-size: 15px; }
  .meta-label { margin: 0; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
  .meta-value { margin: 2px 0 0 0; font-size: 18px; color: #0f172a; font-weight: 700; }
  .separator { color: #cbd5e1; margin: 0 6px; }

  .banner-warning {
    display: flex;
    gap: 12px;
    border: 1px solid #f59e0b;
    background: #fef3c7;
    padding: 12px 14px;
    border-radius: 12px;
    margin-bottom: 14px;
  }
  .banner-icon { font-size: 20px; }
  .banner-title { margin: 0; font-weight: 700; color: #92400e; }
  .banner-body { margin: 4px 0 8px 0; color: #92400e; }
  .banner-subtle { margin: 0; color: #92400e; font-size: 13px; }
  .banner-subtle.success { color: #065f46; }
  .appeal-form { display: flex; flex-direction: column; gap: 8px; max-width: 420px; }
  .appeal-form .form-control { width: 100%; padding: 8px 10px; border:1px solid #d1d5db; border-radius: 8px; }
  .btn-ghost {
    width: fit-content;
    padding: 8px 12px;
    border: 1px solid #111827;
    border-radius: 8px;
    background: #fff;
    color: #111827;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-gold {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #78350f;
    border: none;
    padding: 8px 8px;
    border-radius: 999px;
    font-weight: 700;
    cursor: pointer;
    min-width: 140px;
    text-align: center;
  }

  .owner-mode .slot { cursor: pointer; pointer-events: auto; transform: none; }
  .owner-mode .slot:hover { transform: none; }

  .current-activity-section { margin: 2rem 0; }
  .current-activity-section h3 { margin-bottom: 0.75rem; font-size: 1.25rem; }
  .section-heading { margin-bottom: 0.75rem; font-size: 1.25rem; }
  .activity-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  }
  .activity-table th,
  .activity-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
  }
  .activity-table th {
    background-color: #fafafa;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    color: #374151;
  }
  .activity-table td { font-size: 14px; color: #111827; }
  .activity-table tbody tr:last-child td { border-bottom: none; }
  .current-activity-section p { color: #6b7280; font-style: italic; margin-top: 0.5rem; }
  .activity-table th:last-child,
  .activity-table td:last-child { text-align: center; }

  .activity-actions { display: flex; gap: 8px; justify-content: center; }

  .btn-action-warn {
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #d97706;
    color: #d97706;
    background: #fffbeb;
    border-radius: 6px;
    cursor: pointer;
  }
  .btn-action-warn:hover { background: #fef3c7; }

  .btn-action-revert {
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #52525b;
    color: #3f3f46;
    background: #f4f4f5;
    border-radius: 6px;
    cursor: pointer;
  }
  .btn-action-revert:hover { background: #e4e4e7; }

  .status-note { font-size: 11px; color: #6b7280; white-space: nowrap; }
  .status-note-complete { font-size: 12px; color: #16a34a; font-weight: 500; white-space: nowrap; padding: 5px 0; }

  .return-form-wrapper {
    display: flex; flex-direction: column; gap: 6px; align-items: center;
    border-left: 2px solid #e5e7eb; padding-left: 8px; margin-left: 8px;
  }
  .return-form { display: flex; gap: 6px; }
  .return-input { width: 50px; padding: 4px 6px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 6px; }

  .delete-panel {
    margin-top: 24px;
    padding: 16px;
    border: 1px solid #fca5a5;
    background: #fef2f2;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }
  .btn-danger-solid {
    background: #b91c1c;
    color: #fff;
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
  }
</style>

<% today    = @tz.today %>
<% max_day  = today + 7.days %>
<% prev_day = @day - 1.day %>
<% next_day = @day + 1.day %>

<div class="date-nav" style="display:flex; align-items:center; gap:10px; margin:.5rem 0 1rem;">
  <!-- Prev -->
  <%= link_to "←", workspace_path(@workspace, day: prev_day),
        class: "btn-primary",
        style: "padding:6px 10px; text-decoration:none; opacity:#{@day <= today ? 0.4 : 1}; pointer-events:#{@day <= today ? 'none' : 'auto'}" %>

  <!-- Date display -->
  <div style="font-weight:600; min-width: 220px; text-align:center;">
    <%= @day.strftime("%A, %B %-d") %>
  </div>

  <!-- Next -->
  <%= link_to "→", workspace_path(@workspace, day: next_day),
        class: "btn-primary",
        style: "padding:6px 10px; text-decoration:none; opacity:#{@day >= max_day ? 0.4 : 1}; pointer-events:#{@day >= max_day ? 'none' : 'auto'}" %>

  <!-- Date picker -->
  <form action="<%= workspace_path(@workspace) %>" method="get" style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <input type="date"
           name="day"
           value="<%= @day.iso8601 %>"
           min="<%= today.iso8601 %>"
           max="<%= max_day.iso8601 %>">
    <button class="btn-primary" type="submit" style="padding:6px 10px;">Go</button>
  </form>
</div>

<div class="legend">
  <span class="key">
    <span class="swatch" style="background:#86efac; border:1px solid #4ade80;"></span>
    Available
  </span>
  <% unless is_owner %>
    <span class="key"><span class="swatch" style="background:#3b82f6;"></span>Your Selection</span>
  <% end %>
  <span class="key"><span class="swatch" style="background:#f3f4f6; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #e5e7eb 5px, #e5e7eb 10px);"></span>Unavailable</span>
</div>

<% if is_owner %>
  <div style="margin-bottom:1rem; text-align:right;">
    <%= link_to "Add Item", new_workspace_item_path(@workspace), class: "btn-primary" %>
  </div>
<% end %>

<div class="schedule-wrapper <%= 'owner-mode' if is_owner %>">
  <div class="schedule-grid" id="schedule-grid">
    <!-- Header -->
    <div class="cell corner sticky-1">Item</div>
    <div class="cell corner-2 sticky-2">Quantity</div>
    <% @slots.each_with_index do |slot, index| %>
      <% if index % 8 == 0 %>
        <% span = [@slots.size - index, 8].min %>
        <div class="cell time-cell" style="grid-column: span <%= span %>; text-align: left; padding-left: 5px; border-left: 1px solid #d1d5db;">
          <%= slot.strftime("%-I %p") %>
        </div>
      <% end %>
    <% end %>

    <!-- Rows from backend availability -->
    <% @availability_data.each do |row| %>
      <% item = row[:item] %>
      <div class="cell sticky-1 item-name">
        <% if is_owner %>
          <%= link_to item.name, edit_workspace_item_path(@workspace, item), style: "text-decoration:none; color:#111827;" %>
        <% else %>
          <%= item.name %>
        <% end %>
      </div>

      <div class="cell sticky-2">
        <% if is_owner %>
          <span style="font-weight:600;"><%= item.quantity || 0 %></span>
        <% else %>
          <div class="qty-wrap" data-item-id="<%= item.id %>" data-workspace-id="<%= item.workspace_id %>">
            <div class="qty-controls">
              <button class="qty-btn qty-up" type="button" aria-label="Increase">▲</button>
              <button class="qty-btn qty-down" type="button" aria-label="Decrease">▼</button>
            </div>
            <span class="qty-display" data-count="0">0</span>
            <span class="qty-cap">/ <%= item.quantity || 0 %></span>
          </div>
        <% end %>
      </div>

      <% row[:slots].each do |s| %>
        <% klass =
          if !s[:within_window]
            'outside'
          elsif s[:available]
            'available'
          else
            'unavailable'
          end
        %>

        <% start_iso = s[:start].iso8601 %>
        <% owner_bookings = (defined?(@booking_tooltips) && is_owner) ? @booking_tooltips.dig(item.id, start_iso) : nil %>
        <% bookings_str = owner_bookings.present? ? owner_bookings.map { |b| b[:label] }.join(', ') : nil %>

        <div class="cell" style="padding:0;"
            <%# expose bookings for owner hover (no visual change) %>
            <% if is_owner && bookings_str.present? %>
              data-bookings="<%= bookings_str %>"
              data-time-label="<%= s[:start].strftime('%-I:%M %p') %>–<%= s[:end].strftime('%-I:%M %p') %>"
              data-item-name="<%= item.name %>"
            <% end %>>
          <div
            class="slot <%= klass %>"
            data-item-id="<%= item.id %>"
            data-start="<%= start_iso %>"
            data-end="<%= s[:end].iso8601 %>"
            data-within-window="<%= s[:within_window] %>"
            <% if is_owner && owner_bookings.present? %>
              data-reservations='<%= raw owner_bookings.to_json %>'
            <% end %>
            <% unless is_owner %>
              title="<%= "#{item.name} — #{s[:start].strftime('%-I:%M %p')}–#{s[:end].strftime('%-I:%M %p')}" %>"
            <% end %>
          ></div>
</div>

      <% end %>
    <% end %>
  </div>
</div>

<% unless is_owner %>
  <div class="actions-bar">
    <button
      type="button"
      class="btn-primary"
      id="add-to-cart"
      <%= "disabled" if @penalty %>>
      Add to Cart
    </button>
  </div>
<% end %>

<% if is_owner %>
  <div class="current-activity-section" style="margin-top: 2rem;">
    <h3 class="section-heading">Upcoming Reservations</h3>
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
      <form action="<%= workspace_path(@workspace) %>" method="get" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:0;">
        <input type="hidden" name="day" value="<%= @day.iso8601 %>">
        <label style="margin:0;">Date:</label>
        <input type="date" name="filter_day" value="<%= @filter_day&.iso8601 %>" min="<%= today.iso8601 %>">
        <label style="margin:0;">Item:</label>
        <select name="filter_item_id" class="form-select form-select-sm" style="min-width:180px; height:30px; padding:4px 8px; font-size:15px;">
          <option value="">All items</option>
          <% @items.each do |item| %>
            <option value="<%= item.id %>" <%= "selected" if @filter_item_id.to_i == item.id %>><%= item.name %></option>
          <% end %>
        </select>
        <button type="submit" class="btn btn-sm btn-outline-secondary">Apply</button>
      </form>
    </div>

    <% if @upcoming_reservations.any? %>
      <table class="activity-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>User</th>
            <th>Quantity</th>
            <th>Starts</th>
            <th>Ends</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @upcoming_reservations.each do |reservation| %>
            <tr>
              <td><%= reservation.item.name %></td>
              <td><%= reservation.user.name %></td>
              <td><%= reservation.quantity %></td>
              <td><%= reservation.start_time.strftime("%b %-d, %-I:%M %p") %></td>
              <td><%= reservation.end_time.strftime("%b %-d, %-I:%M %p") %></td>
              <td>
                <%= link_to "View", reservation_path(reservation), class: "btn btn-sm btn-outline-secondary" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No upcoming reservations match your filters.</p>
    <% end %>
  </div>
<% end %>


<script>
  (function ownerHoverTooltip(){
    const isOwner = <%= is_owner ? 'true' : 'false' %>;
    if (!isOwner) return;

    const grid = document.getElementById('schedule-grid');
    if (!grid) return;

    // create tooltip once
    let tip = document.getElementById('slot-tooltip');
    if (!tip) {
      tip = document.createElement('div');
      tip.id = 'slot-tooltip';
      document.body.appendChild(tip);
    }

    function showTooltip(html, x, y) {
      tip.innerHTML = html;
      tip.style.display = 'block';
      // position with a small offset
      const pad = 12;
      const vw = window.innerWidth, vh = window.innerHeight;
      tip.style.left = Math.min(x + pad, vw - tip.offsetWidth - 6) + 'px';
      tip.style.top  = Math.min(y + pad, vh - tip.offsetHeight - 6) + 'px';
    }
    function hideTooltip() {
      tip.style.display = 'none';
    }

    function buildHtml(target) {
      const bookings = target.getAttribute('data-bookings');
      if (!bookings) return null;
      const item = target.getAttribute('data-item-name') || 'Item';
      const when = target.getAttribute('data-time-label') || '';
      return `
        <div class="t-hed">${item}${when ? ` — ${when}` : ''}</div>
        <div class="t-body">${bookings}</div>
      `;
    }

    // delegate: look for nearest element with data-bookings
    function findCell(el) {
      return el.closest('[data-bookings]');
    }

    grid.addEventListener('mousemove', (e) => {
      const cell = findCell(e.target);
      if (!cell) { hideTooltip(); return; }
      const html = buildHtml(cell);
      if (!html) { hideTooltip(); return; }
      showTooltip(html, e.clientX, e.clientY);
    });

    grid.addEventListener('mouseleave', hideTooltip);
  })();
  (function ownerSlotClickthrough() {
    const isOwner = <%= is_owner ? 'true' : 'false' %>;
    if (!isOwner) return;
    const grid = document.getElementById('schedule-grid');
    if (!grid) return;

    grid.addEventListener('click', (e) => {
      const slot = e.target.closest('.slot');
      if (!slot) return;
      const data = slot.dataset.reservations;
      if (!data) return;
      let reservations = [];
      try {
        reservations = JSON.parse(data);
      } catch (err) {
        return;
      }
      if (!Array.isArray(reservations) || reservations.length === 0) return;

      if (reservations.length === 1) {
        window.location.href = `/reservations/${reservations[0].id}`;
        return;
      }

      const promptText = reservations.map((r, idx) => `${idx + 1}) ${r.label}`).join('\n');
      const input = window.prompt(`Multiple reservations in this slot. Enter a number to open:\n${promptText}`, "1");
      const choice = parseInt(input, 10);
      if (choice && choice >= 1 && choice <= reservations.length) {
        window.location.href = `/reservations/${reservations[choice - 1].id}`;
      }
    });
  })();
  (function () {
    const isOwner = <%= is_owner ? 'true' : 'false' %>;
    if (isOwner) return; // owners don't interact

    // Initialize quantity button disabled states
    document.querySelectorAll('.qty-wrap').forEach(wrap => {
      const capText = wrap.querySelector('.qty-cap')?.textContent || "/ 0";
      const cap = parseInt(capText.replace("/", "").trim(), 10) || 0;
      const upBtn = wrap.querySelector('.qty-up');
      const downBtn = wrap.querySelector('.qty-down');
      if (upBtn) upBtn.disabled = (cap <= 0);
      if (downBtn) downBtn.disabled = true;
    });

    document.addEventListener('click', function (e) {
      // Slot toggling
      const slot = e.target.closest('.slot');
      if (slot) {
        // block clicks on red (unavailable) and gray (outside)
        if (slot.classList.contains('unavailable') || slot.classList.contains('outside')) return;

        // toggle green <-> orange
        if (slot.classList.contains('available')) {
          slot.classList.remove('available');
          slot.classList.add('selected');
        } else if (slot.classList.contains('selected')) {
          slot.classList.remove('selected');
          slot.classList.add('available');
        }
        return;
      }

      // Quantity controls
      const up = e.target.closest('.qty-up');
      const down = e.target.closest('.qty-down');
      if (up || down) {
        const wrap = e.target.closest('.qty-wrap');
        if (!wrap) return;

        const itemId = wrap.dataset.itemId;
        const display = wrap.querySelector('.qty-display');
        const capText = wrap.querySelector('.qty-cap')?.textContent || "/ 0";
        const cap = parseInt(capText.replace("/", "").trim(), 10) || 0;

        let count = parseInt(display.dataset.count || "0", 10);
        if (up && count < cap) count += 1;
        if (down && count > 0) count -= 1;

        display.dataset.count = String(count);
        display.textContent = String(count);

        const upBtn = wrap.querySelector('.qty-up');
        const downBtn = wrap.querySelector('.qty-down');
        if (upBtn) upBtn.disabled = (count >= cap);
        if (downBtn) downBtn.disabled = (count <= 0);

        // Repaint this item's row based on backend availability for selected quantity
        const selectedDay = document.getElementById('selected-day')?.dataset.day; // YYYY-MM-DD
        const dayParam = selectedDay ? `&day=${encodeURIComponent(selectedDay)}` : '';
        fetch(`/reservations/availability?item_id=${encodeURIComponent(itemId)}&quantity=${encodeURIComponent(count)}${dayParam}`, {
          headers: { 'Accept': 'application/json' }
        })
          .then(r => r.json())
          .then(({ slots }) => {
            const rowSlots = document.querySelectorAll(`.slot[data-item-id="${itemId}"]`);
            const byStart = {};
            slots.forEach(s => { byStart[new Date(s.start).toISOString()] = s; });

            rowSlots.forEach(el => {
              const key = new Date(el.dataset.start).toISOString();
              const s = byStart[key];
              if (!s) return;

              const wasSelected = el.classList.contains('selected');

              el.classList.remove('available','selected','unavailable','outside');

              if (!s.within_window) {
                el.classList.add('outside');                   // gray
              } else if (s.available) {
                el.classList.add(wasSelected ? 'selected' : 'available'); // keep orange if user picked
              } else {
                el.classList.add('unavailable');               // red
              }
            });
          })
          .catch(() => { /* ignore for now */ });

        return;
      }

      // Add to Cart
      const addBtn = e.target.closest('#add-to-cart');
      if (addBtn) {
        const selected = Array.from(document.querySelectorAll('.slot.selected'));
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (selected.length === 0) {
          alert('Select at least one time slot first.');
          return;
        }

        const selections = selected.map(el => {
          const itemId = parseInt(el.dataset.itemId, 10);
          const wrap = document.querySelector(`.qty-wrap[data-item-id="${itemId}"]`);
          const qty = wrap ? parseInt(wrap.querySelector('.qty-display')?.dataset.count || "1", 10) : 1;
          const workspaceId = wrap ? parseInt(wrap.dataset.workspaceId || "0", 10) : 0;

          return {
            item_id: itemId,
            workspace_id: workspaceId,
            start_time: el.dataset.start,
            end_time: el.dataset.end,
            quantity: qty || 1
          };
        });

        fetch('/cart_items', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ selections })
        })
          .then(r => r.json())
          .then(({ ok, total }) => {
            if (!ok) throw new Error('failed');

            // Clear selections back to "available"
            selected.forEach(el => {
              el.classList.remove('selected');
              el.classList.add('available');
            });

            // Update navbar "Cart (N)" if present
            const navLink = document.querySelector('a[href="/cart"]');
            if (navLink && typeof total === 'number') {
              navLink.textContent = `Cart (${total})`;
            }

            alert('Added to cart!');
          })
          .catch(() => alert('Something went wrong adding to the cart.'));

        return;
      }
    }, { passive: false });
  })();
</script>
