<% def trend_arrow(direction)
     case direction
     when :up   then "▲"
     when :down then "▼"
     else "➜"
     end
   end

   def trend_color(direction)
     case direction
     when :up   then "color:#16a34a;"   # green-600
     when :down then "color:#dc2626;"   # red-600
     else            "color:#6b7280;"   # gray-500
     end
   end
%>

<div class="workspace-hero">
  <div>
    <h1 class="workspace-title"><%= @workspace.name %></h1>
    <p class="workspace-meta">
      <strong>Owner:</strong> <%= @workspace.owner&.name || "Unassigned" %>
      <% if @workspace.respond_to?(:description) && @workspace.description.present? %>
        <br>
        <strong>Description:</strong> <%= @workspace.description %>
      <% end %>
    </p>

    <% if current_user_is_owner?(@workspace) %>
      <div class="hero-actions">
        <%= link_to "View Missing Items", workspace_missing_reports_path(@workspace), class: "btn-pill" %>
        <%= link_to "Edit Workspace", edit_workspace_path(@workspace), class: "link-inline" %>
      </div>
    <% end %>
  </div>

  <% if @current_join.nil? || @current_join.role == 'user' %>
    <div class="hero-meta">
      <%= button_to (@current_join ? "Unbookmark" : "Bookmark"),
                    workspace_user_to_workspace_path(@workspace),
                    method: (@current_join ? :delete : :post),
                    class: "btn-gold",
                    data: (@current_join ? { confirm: "Remove this workspace from your bookmarks?" } : {}) %>
    </div>
  <% end %>

  <% if current_user_is_owner?(@workspace) %>
    <div class="workspace-stats" style="
        margin-left:auto;
        display:flex;
        flex-direction:column;
        gap:10px;
        max-width:360px;
        padding:14px;
        background:#f9fafb;
        border-radius:8px;
        border:1px solid #e5e7eb;
    ">
      <h3 style="margin:0 0 6px 0; font-size:16px; font-weight:600;">
        Quick Workspace Stats
        <span style="font-size:12px; color:#6b7280; font-weight:400;">
          *last 7 days
        </span>
      </h3>

      <!-- WEEKLY TREND -->
      <div class="stat-line" style="display:flex; justify-content:space-between;">
        <div style="font-weight:600;">Reseravtion Count</div>
        <div>
          <%= @this_week_count %>
          <span style="<%= trend_color(@weekly_trend) %>; margin-left:4px;">
            <%= trend_arrow(@weekly_trend) %>
          </span>
        </div>
      </div>

      <!-- TOP USED -->
      <div class="stat-line" style="display:flex; justify-content:space-between;">
        <div style="font-weight:600;">Top Used Item:</div>
        <div><%= @top_item&.name || "—" %></div>
      </div>

      <!-- LEAST USED -->
      <div class="stat-line" style="display:flex; justify-content:space-between;">
        <div style="font-weight:600;">Least Used Item:</div>
        <div><%= @least_item&.name || "—" %></div>
      </div>

      <!-- VIEW ANALYTICS BUTTON -->
      <div style="margin-top:14px;">
        <%= link_to "View More Item/User Analytics",
                    analytics_workspace_path(@workspace),
                    class: "btn-primary",
                    style: "width:100%; text-align:center; padding:10px 12px;" %>
      </div>
    </div>
  <% end %>
</div>

<% if @penalty && !current_user_is_owner?(@workspace) %>
  <div class="banner-warning">
    <div class="banner-icon">⚠️</div>
    <div>
      <p class="banner-title">Penalty Notice</p>
      <p class="banner-body">
        You are blocked from making reservations in this workspace due to a
        <%= @penalty.reason.humanize.downcase %>. You’ll regain access after
        <strong><%= @penalty.expires_at.strftime("%B %-d at %-I:%M %p") %></strong>.
      </p>
      <% if @penalty.appeal_pending? %>
        <p class="banner-subtle">Appeal submitted — waiting on owner review.</p>
      <% elsif @penalty.appeal_state == "resolved" %>
        <p class="banner-subtle success">Appeal reviewed by owner.</p>
      <% else %>
        <%= form_with url: appeal_penalty_path(@penalty), method: :post, local: true, html: { class: "appeal-form" } do %>
          <%= text_field_tag :appeal_message, nil, placeholder: "Share context (optional)", class: "form-control" %>
          <%= submit_tag "Appeal Penalty", class: "btn-ghost" %>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<hr>

<% is_owner = @current_join&.role == 'owner' %>

<% slots = @slots %>

<% today    = @tz.today %>
<% max_day  = today + 7.days %>
<% prev_day = @day - 1.day %>
<% next_day = @day + 1.day %>

<% if is_owner %>
  <div class="current-activity-section">
    <h3 class="section-heading">Current Reservations at <%= @tz.now.strftime("%-I:%M %p %Z") %></h3>
    <% if @current_activity.any? %>
      <table class="activity-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>User</th>
            <th>Quantity</th>
            <th>Starts</th>
            <th>Ends</th>
            <th>No Show</th>
            <th>Return Items</th>
          </tr>
        </thead>
        <tbody>
          <% @current_activity.each do |reservation| %>
            <tr>
              <td><%= reservation.item.name %></td>
              <td>
                <%= link_to reservation.user.name,
                            workspace_user_path(@workspace, reservation.user),
                            class: "link-inline" %>
              </td>
              <td><%= reservation.quantity %></td>
              <td><%= reservation.start_time.strftime("%-I:%M %p") %></td>
              <td><%= reservation.end_time.strftime("%-I:%M %p") %></td>
              <td>
                <div class="activity-actions">
                  <% if reservation.no_show? %>
                    <%= button_to "Undo No Show",
                                  mark_no_show_reservation_path(reservation),
                                  method: :patch,
                                  class: "btn-action-revert" %>
                  <% else %>
                    <%= button_to "Mark No Show",
                                  mark_no_show_reservation_path(reservation),
                                  method: :patch,
                                  class: "btn-action-warn",
                                  data: { confirm: "Are you sure? This will mark '#{reservation.user.name}' as a 'No Show'." } %>
                  <% end %>
                </div>
              </td>
              <td>
                <div class="return-form-wrapper">
                  <%
                    total = reservation.quantity
                    returned = reservation.returned_count
                    still_missing = total - returned
                  %>

                  <% if still_missing > 0 %>
                    <%= form_with(url: return_items_reservation_path(reservation), method: :patch, class: "return-form") do |f| %>
                      <%= number_field_tag :quantity_to_return, nil,
                            placeholder: "Qty",
                            class: "return-input",
                            min: 1,
                            max: still_missing %>
                      <%= f.submit "Return", class: "btn-action-revert" %>
                    <% end %>
                  <% elsif returned > 0 %>
                    <%= form_with(url: undo_return_items_reservation_path(reservation), method: :patch, class: "return-form") do |f| %>
                      <%= number_field_tag :quantity_to_undo, nil,
                            placeholder: "Qty",
                            class: "return-input",
                            min: 1,
                            max: returned %>
                      <%= f.submit "Undo", class: "btn-action-warn" %>
                    <% end %>
                  <% end %>

                  <% if still_missing == 0 %>
                    <span class="status-note-complete">All items returned</span>
                  <% else %>
                    <span class="status-note">(<%= still_missing %> / <%= total %> missing)</span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No current activity in this workspace.</p>
    <% end %>
  </div>
<% end %>

<div class="date-nav" style="display:flex; align-items:center; gap:10px; margin:.5rem 0 1rem;">
  <!-- Prev -->
  <%= link_to "←", workspace_path(@workspace, day: prev_day),
        class: "btn-primary",
        style: "padding:6px 10px; text-decoration:none; opacity:#{@day <= today ? 0.4 : 1}; pointer-events:#{@day <= today ? 'none' : 'auto'}" %>

  <!-- Date display -->
  <div style="font-weight:600; min-width: 220px; text-align:center;">
    <%= @day.strftime("%A, %B %-d") %>
  </div>

  <!-- Next -->
  <%= link_to "→", workspace_path(@workspace, day: next_day),
        class: "btn-primary",
        style: "padding:6px 10px; text-decoration:none; opacity:#{@day >= max_day ? 0.4 : 1}; pointer-events:#{@day >= max_day ? 'none' : 'auto'}" %>

  <!-- Date picker -->
  <form action="<%= workspace_path(@workspace) %>" method="get" style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <input type="date"
           name="day"
           value="<%= @day.iso8601 %>"
           min="<%= today.iso8601 %>"
           max="<%= max_day.iso8601 %>">
    <button class="btn-primary" type="submit" style="padding:6px 10px;">Go</button>
  </form>
</div>

<div class="legend">
  <span class="key">
    <span class="swatch" style="background:#86efac; border:1px solid #4ade80;"></span>
    Available
  </span>

  <% if is_owner %>
    <span class="key"><span class="swatch" style="background:#facc1533;"></span>Partially Reserved</span>
  <% else %>
    <span class="key"><span class="swatch" style="background:#facc1533;"></span>Partially Reserved</span>
    <span class="key"><span class="swatch" style="background:#3b82f6;"></span>Your Selection</span>
  <% end %>

  <span class="key"><span class="swatch" style="background:#f3f4f6; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #e5e7eb 5px, #e5e7eb 10px);"></span>Unavailable</span>
</div>

<% if is_owner %>
  <div style="margin-bottom:1rem; text-align:right;">
    <%= link_to "Add Item", new_workspace_item_path(@workspace), class: "btn-primary" %>
  </div>
<% end %>

<div class="schedule-wrapper <%= 'owner-mode' if is_owner %>">
  <div class="schedule-grid" id="schedule-grid" style="--slot-count: <%= @slots.size %>;">
    <!-- Header -->
    <div class="cell corner sticky-1">Item</div>
    <div class="cell corner-2 sticky-2">Qty</div>
    <% @slots.each_with_index do |slot, index| %>
      <% if index % 8 == 0 %>
        <% span = [@slots.size - index, 8].min %>
        <div class="cell time-cell" style="grid-column: span <%= span %>; text-align: left; padding-left: 5px; border-left: 1px solid #d1d5db;">
          <%= slot.strftime("%-I %p") %>
        </div>
      <% end %>
    <% end %>

    <!-- Rows from backend availability -->
    <% @availability_data.each do |row| %>
      <% item = row[:item] %>
      <div class="cell sticky-1 item-name">
        <% if is_owner %>
          <%= link_to item.name, edit_workspace_item_path(@workspace, item), style: "text-decoration:none; color:#111827;" %>
        <% else %>
          <%= item.name %>
        <% end %>
      </div>

      <div class="cell sticky-2">
        <% if is_owner %>
          <span style="font-weight:600;"><%= item.quantity || 0 %></span>
        <% else %>
          <div class="qty-wrap" data-item-id="<%= item.id %>" data-workspace-id="<%= item.workspace_id %>">
            <div class="qty-controls">
              <button class="qty-btn qty-down" type="button" aria-label="Decrease">‹</button>
              <span class="qty-display" data-count="1">1</span>
              <button class="qty-btn qty-up" type="button" aria-label="Increase">›</button>
            </div>
            <span class="qty-cap">/ <%= item.quantity || 0 %></span>
          </div>
        <% end %>
      </div>

      <% row[:slots].each do |s| %>
        <% total = (s[:total_quantity] || 0).to_i
           used  = (s[:used_quantity]  || 0).to_i

           klass =
             if !s[:within_window]
               'outside'
             elsif total <= 0
               'unavailable'
             elsif used == 0
               s[:available] ? 'available' : 'unavailable'
             elsif used < total && s[:available]
               'partial'
             else
               'unavailable'
             end

           base_state = %w[available partial].include?(klass) ? klass : nil
        %>

        <% start_iso = s[:start].iso8601 %>
        <% owner_bookings = (defined?(@booking_tooltips) && is_owner) ? @booking_tooltips.dig(item.id, start_iso) : nil %>
        <% bookings_str = owner_bookings.present? ? owner_bookings.map { |b| b[:label] }.join(', ') : nil %>

        <div class="cell" style="padding:0;"
             <% if is_owner && bookings_str.present? %>
               data-bookings="<%= bookings_str %>"
               data-time-label="<%= s[:start].strftime('%-I:%M %p') %>–<%= s[:end].strftime('%-I:%M %p') %>"
               data-item-name="<%= item.name %>"
             <% end %>>
          <div
            class="slot <%= klass %>"
            data-item-id="<%= item.id %>"
            data-start="<%= start_iso %>"
            data-end="<%= s[:end].iso8601 %>"
            data-within-window="<%= s[:within_window] %>"
            <% if base_state %> data-base-state="<%= base_state %>" <% end %>
            <% if is_owner && owner_bookings.present? %>
              data-reservations='<%= raw owner_bookings.to_json %>'
            <% end %>
            <% unless is_owner %>
              title="<%= "#{item.name} — #{s[:start].strftime('%-I:%M %p')}–#{s[:end].strftime('%-I:%M %p')}" %>"
            <% end %>
          ></div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<% unless is_owner %>
  <div class="actions-bar">
    <button
      type="button"
      class="btn-primary"
      id="add-to-cart"
      <%= "disabled" if @penalty %>>
      Add to Cart
    </button>
  </div>
<% end %>

<% if is_owner %>
  <div class="current-activity-section" style="margin-top: 2rem;">
    <h3 class="section-heading">
      Upcoming Reservations
      <span style="font-size: 0.8em; margin-left: 10px;">
        <%= link_to "View past reservations",
                    past_reservations_workspace_path(@workspace),
                    class: "link-inline" %>
      </span>
    </h3>
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
      <form action="<%= workspace_path(@workspace) %>" method="get" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:0;">
        <input type="hidden" name="day" value="<%= @day.iso8601 %>">
        <label style="margin:0;">Date:</label>
        <input type="date" name="filter_day" value="<%= @filter_day&.iso8601 %>" min="<%= today.iso8601 %>">
        <label style="margin:0;">Item:</label>
        <select name="filter_item_id" class="form-select form-select-sm" style="min-width:180px; height:30px; padding:4px 8px; font-size:15px;">
          <option value="">All items</option>
          <% @items.each do |item| %>
            <option value="<%= item.id %>" <%= "selected" if @filter_item_id.to_i == item.id %>><%= item.name %></option>
          <% end %>
        </select>
        <button type="submit" class="btn btn-sm btn-outline-secondary">Apply</button>
      </form>
    </div>

    <% if @upcoming_reservations.any? %>
      <table class="activity-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>User</th>
            <th>Quantity</th>
            <th>Starts</th>
            <th>Ends</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @upcoming_reservations.each do |reservation| %>
            <tr>
              <td><%= reservation.item.name %></td>
              <td>
                <%= link_to reservation.user.name,
                            workspace_user_path(@workspace, reservation.user),
                            class: "link-inline" %>
              </td>
              <td><%= reservation.quantity %></td>
              <td><%= reservation.start_time.strftime("%b %-d, %-I:%M %p") %></td>
              <td><%= reservation.end_time.strftime("%b %-d, %-I:%M %p") %></td>
              <td>
                <%= link_to "View", reservation_path(reservation), class: "btn btn-sm btn-outline-secondary" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No upcoming reservations match your filters.</p>
    <% end %>
  </div>
<% end %>


<script>
  (function ownerHoverTooltip(){
    const isOwner = <%= is_owner ? 'true' : 'false' %>;
    if (!isOwner) return;

    const grid = document.getElementById('schedule-grid');
    if (!grid) return;

    // create tooltip once
    let tip = document.getElementById('slot-tooltip');
    if (!tip) {
      tip = document.createElement('div');
      tip.id = 'slot-tooltip';
      document.body.appendChild(tip);
    }

    function showTooltip(html, x, y) {
      tip.innerHTML = html;
      tip.style.display = 'block';
      // position with a small offset
      const pad = 12;
      const vw = window.innerWidth, vh = window.innerHeight;
      tip.style.left = Math.min(x + pad, vw - tip.offsetWidth - 6) + 'px';
      tip.style.top  = Math.min(y + pad, vh - tip.offsetHeight - 6) + 'px';
    }
    function hideTooltip() {
      tip.style.display = 'none';
    }

    function buildHtml(target) {
      const bookings = target.getAttribute('data-bookings');
      if (!bookings) return null;
      const item = target.getAttribute('data-item-name') || 'Item';
      const when = target.getAttribute('data-time-label') || '';
      return `
        <div class="t-hed">${item}${when ? ` — ${when}` : ''}</div>
        <div class="t-body">${bookings}</div>
      `;
    }

    // delegate: look for nearest element with data-bookings
    function findCell(el) {
      return el.closest('[data-bookings]');
    }

    grid.addEventListener('mousemove', (e) => {
      const cell = findCell(e.target);
      if (!cell) { hideTooltip(); return; }
      const html = buildHtml(cell);
      if (!html) { hideTooltip(); return; }
      showTooltip(html, e.clientX, e.clientY);
    });

    grid.addEventListener('mouseleave', hideTooltip);
  })();
  (function ownerSlotClickthrough() {
    const isOwner = <%= is_owner ? 'true' : 'false' %>;
    if (!isOwner) return;
    const grid = document.getElementById('schedule-grid');
    if (!grid) return;

    grid.addEventListener('click', (e) => {
      const slot = e.target.closest('.slot');
      if (!slot) return;
      const data = slot.dataset.reservations;
      if (!data) return;
      let reservations = [];
      try {
        reservations = JSON.parse(data);
      } catch (err) {
        return;
      }
      if (!Array.isArray(reservations) || reservations.length === 0) return;

      if (reservations.length === 1) {
        window.location.href = `/reservations/${reservations[0].id}`;
        return;
      }

      const promptText = reservations.map((r, idx) => `${idx + 1}) ${r.label}`).join('\n');
      const input = window.prompt(`Multiple reservations in this slot. Enter a number to open:\n${promptText}`, "1");
      const choice = parseInt(input, 10);
      if (choice && choice >= 1 && choice <= reservations.length) {
        window.location.href = `/reservations/${reservations[choice - 1].id}`;
      }
    });
  })();
  (function () {
    const isOwner = <%= is_owner ? 'true' : 'false' %>;
    if (isOwner) return; // owners don't interact

    // Initialize quantity button disabled states (min = 1)
    document.querySelectorAll('.qty-wrap').forEach(wrap => {
      const capText = wrap.querySelector('.qty-cap')?.textContent || "/ 0";
      const cap = parseInt(capText.replace("/", "").trim(), 10) || 0;
      const upBtn = wrap.querySelector('.qty-up');
      const downBtn = wrap.querySelector('.qty-down');
      const display = wrap.querySelector('.qty-display');

      let count = parseInt(display.dataset.count || "1", 10);
      if (count < 1) count = 1; // safety

      if (upBtn)  upBtn.disabled   = (count >= cap);
      if (downBtn) downBtn.disabled = (count <= 1);
    });


    // Drag-to-select for slots
    let isDragging = false;
    let dragStartSlot = null;
    let currentItemId = null;
    let draggedSlots = new Set();

    document.addEventListener('mousedown', function (e) {
      const slot = e.target.closest('.slot');
      if (slot && !slot.classList.contains('unavailable') && !slot.classList.contains('outside')) {
        isDragging = true;
        dragStartSlot = slot;
        currentItemId = slot.dataset.itemId;
        draggedSlots.clear();
        draggedSlots.add(slot);
        
        // Toggle the starting slot
        const baseState = slot.dataset.baseState || (slot.classList.contains('partial') ? 'partial' : 'available');
        if (!slot.classList.contains('selected')) {
          slot.classList.remove('available', 'partial');
          slot.classList.add('selected');
        } else {
          slot.classList.remove('selected');
          if (baseState === 'partial') {
            slot.classList.add('partial');
          } else {
            slot.classList.add('available');
          }
        }
        e.preventDefault();
      }
    });

    document.addEventListener('mousemove', function (e) {
      if (!isDragging || !dragStartSlot) return;
      
      const slot = e.target.closest('.slot');
      if (slot && slot.dataset.itemId === currentItemId && 
          !slot.classList.contains('unavailable') && 
          !slot.classList.contains('outside')) {
        
        if (!draggedSlots.has(slot)) {
          draggedSlots.add(slot);
          
          const baseState = slot.dataset.baseState || (slot.classList.contains('partial') ? 'partial' : 'available');
          const isStartSelected = dragStartSlot.classList.contains('selected');
          
          // Apply same action as start slot
          if (isStartSelected) {
            slot.classList.remove('available', 'partial');
            slot.classList.add('selected');
          } else {
            slot.classList.remove('selected');
            if (baseState === 'partial') {
              slot.classList.add('partial');
            } else {
              slot.classList.add('available');
            }
          }
        }
      }
    });

    document.addEventListener('mouseup', function (e) {
      isDragging = false;
      dragStartSlot = null;
      currentItemId = null;
      draggedSlots.clear();
    });

    // Keep click functionality for single clicks (mobile compatibility)
    document.addEventListener('click', function (e) {


      // Quantity controls
      const up = e.target.closest('.qty-up');
      const down = e.target.closest('.qty-down');
      if (up || down) {
        const wrap = e.target.closest('.qty-wrap');
        if (!wrap) return;

        const itemId = wrap.dataset.itemId;
        const display = wrap.querySelector('.qty-display');
        const capText = wrap.querySelector('.qty-cap')?.textContent || "/ 0";
        const cap = parseInt(capText.replace("/", "").trim(), 10) || 0;

        let count = parseInt(display.dataset.count || "1", 10);
        if (up && count < cap) count += 1;
        if (down && count > 1) count -= 1;

        display.dataset.count = String(count);
        display.textContent = String(count);

        const upBtn = wrap.querySelector('.qty-up');
        const downBtn = wrap.querySelector('.qty-down');
        if (upBtn)  upBtn.disabled   = (count >= cap);
        if (downBtn) downBtn.disabled = (count <= 1);

        // Repaint this item's row based on backend availability for selected quantity
        const selectedDay = document.getElementById('selected-day')?.dataset.day; // YYYY-MM-DD
        const dayParam = selectedDay ? `&day=${encodeURIComponent(selectedDay)}` : '';
        fetch(`/reservations/availability?item_id=${encodeURIComponent(itemId)}&quantity=${encodeURIComponent(count)}${dayParam}`, {
          headers: { 'Accept': 'application/json' }
        })
          .then(r => r.json())
          .then(({ slots }) => {
            const rowSlots = document.querySelectorAll(`.slot[data-item-id="${itemId}"]`);
            const byStart = {};
            slots.forEach(s => { byStart[new Date(s.start).toISOString()] = s; });

            rowSlots.forEach(el => {
              const key = new Date(el.dataset.start).toISOString();
              const s = byStart[key];
              if (!s) return;

              const wasSelected = el.classList.contains('selected');

              el.classList.remove('available', 'selected', 'unavailable', 'outside', 'partial');

              let baseClass;

              if (!s.within_window) {
                baseClass = 'outside';
              } else {
                const total = (s.total_quantity ?? 0);
                const used  = (s.used_quantity  ?? 0);

                if (total <= 0) {
                  baseClass = 'unavailable';
                } else if (used === 0) {
                  baseClass = s.available ? 'available' : 'unavailable';
                } else if (used < total && s.available) {
                  baseClass = 'partial';
                } else {
                  baseClass = 'unavailable';
                }
              }

              if (wasSelected &&
                  baseClass !== 'outside' &&
                  baseClass !== 'unavailable') {
                el.classList.add('selected');
              } else {
                el.classList.add(baseClass);
              }

              if (baseClass === 'available' || baseClass === 'partial') {
                el.dataset.baseState = baseClass;
              } else {
                delete el.dataset.baseState;
              }
            });
          })
          .catch(() => { /* ignore for now */ });

        return;
      }

      // Add to Cart
      const addBtn = e.target.closest('#add-to-cart');
      if (addBtn) {
        const selected = Array.from(document.querySelectorAll('.slot.selected'));
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (selected.length === 0) {
          alert('Select at least one time slot first.');
          return;
        }

        const selections = selected.map(el => {
          const itemId = parseInt(el.dataset.itemId, 10);
          const wrap = document.querySelector(`.qty-wrap[data-item-id="${itemId}"]`);
          let qty = wrap ? parseInt(wrap.querySelector('.qty-display')?.dataset.count || "1", 10) : 1;
          if (!qty || qty < 1) qty = 1; // hard floor
          const workspaceId = wrap ? parseInt(wrap.dataset.workspaceId || "0", 10) : 0;

          return {
            item_id: itemId,
            workspace_id: workspaceId,
            start_time: el.dataset.start,
            end_time: el.dataset.end,
            quantity: qty || 1
          };
        });

        fetch('/cart_items', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ selections })
        })
          .then(r => r.json())
          .then(({ ok, total }) => {
            if (!ok) throw new Error('failed');

            // Clear selections back to "available"
            selected.forEach(el => {
              el.classList.remove('selected');
              el.classList.add('available');
              el.dataset.baseState = 'available';
            });


            // Update navbar "Cart (N)" if present
            const navLink = document.querySelector('a[href="/cart"]');
            if (navLink && typeof total === 'number') {
              navLink.textContent = `Cart (${total})`;
            }

            alert('Added to cart!');
          })
          .catch(() => alert('Something went wrong adding to the cart.'));

        return;
      }
    }, { passive: false });
  })();
</script>
