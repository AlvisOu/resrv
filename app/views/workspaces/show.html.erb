<h1><%= @workspace.name %></h1>

<% flash.each do |message_type, message| %>
  <div class="flash flash-<%= message_type %>"><%= message %></div>
<% end %>

<%= link_to "Rename Workspace", edit_workspace_path(@workspace), class: "button" if current_user_is_owner?(@workspace) %>
<p style="font-size:16px;"><strong>Description:</strong> <%= @workspace.name %> ===> Edit later</p>
<p style="font-size:16px;">ID: <%= @workspace.id %></p>
<p style="font-size:16px;">Owner: <%= @workspace.owner&.name %></p>

<hr>
<% is_owner = @current_join&.role == 'owner' %>
<% if is_owner %>
  <div class="current-activity-section">
    <h3>Current Activity at <%= @tz.now.strftime("%-I:%M %p %Z") %></h3>
    <% if @current_activity.any? %>
      <table class="activity-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>User</th>
            <th>Quantity</th>
            <th>Starts</th>
            <th>Ends</th>
            <th>No Show</th>
            <th>Return Items</th>
          </tr>
        </thead>
        <tbody>
          <% @current_activity.each do |reservation| %>
            <tr>
              <td><%= reservation.item.name %></td>
              <td><%= reservation.user.name %></td>
              <td><%= reservation.quantity %></td>
              <td><%= reservation.start_time.strftime("%-I:%M %p") %></td>
              <td><%= reservation.end_time.strftime("%-I:%M %p") %></td>
              <td>
                <div class="activity-actions">
                  
                  <% if reservation.no_show? %>
                    <%= button_to "Undo No Show", 
                                  mark_no_show_reservation_path(reservation), 
                                  method: :patch, 
                                  class: "btn-action-revert" %>
                  <% else %>
                    <%= button_to "Mark No Show", 
                                  mark_no_show_reservation_path(reservation), 
                                  method: :patch, 
                                  class: "btn-action-warn",
                                  data: { confirm: "Are you sure? This will mark '#{reservation.user.name}' as a 'No Show'." } %>
                  <% end %>
                </div>
              </td>
              <td>
                <div class="return-form-wrapper">
                  <% 
                    total = reservation.quantity
                    returned = reservation.returned_count
                    still_missing = total - returned
                  %>
                  
                  <% if still_missing > 0 %>
                    <%= form_with(url: return_items_reservation_path(reservation), method: :patch, class: "return-form") do |f| %>
                      
                      <%= number_field_tag :quantity_to_return, nil, 
                            placeholder: "Qty", 
                            class: "return-input", 
                            min: 1, 
                            max: still_missing %>
                      
                      <%= f.submit "Return", class: "btn-action-revert" %>
                    <% end %>
                  <% elsif returned > 0 %>
                    <%= form_with(url: undo_return_items_reservation_path(reservation), method: :patch, class: "return-form") do |f| %>
                      
                      <%= number_field_tag :quantity_to_undo, nil, 
                            placeholder: "Qty", 
                            class: "return-input", 
                            min: 1, 
                            max: returned %>
                      
                      <%= f.submit "Undo", class: "btn-action-warn" %>
                    <% end %>
                  <% end %>
                  
                  <%# --- STATUS MESSAGE --- %>
                  <% if still_missing == 0 %>
                    <span class="status-note-complete">All items returned</span>
                  <% else %>
                    <span class="status-note">(<%= still_missing %> / <%= total %> missing)</span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No current activity in this workspace.</p>
    <% end %>
  </div>
<% end %>
<%
  # ---------- 24h TIME SLOTS (today 00:00 → tomorrow 00:00) in 15-min intervals ----------
  day = Date.current
  tz  = Time.zone || ActiveSupport::TimeZone["UTC"]

  start_of_day = tz.local(day.year, day.month, day.day, 0, 0, 0)
  end_of_day   = start_of_day + 24.hours

  slots = []
  t = start_of_day
  while t < end_of_day
    slots << t
    t += 15.minutes
  end
%>

<style>
  .legend { display:flex; gap:1.25rem; align-items:center; margin: 0.5rem 0 1rem; font-size:14px; }
  .legend .key { display:inline-flex; align-items:center; gap:0.5rem; }
  .legend .swatch { width:16px; height:16px; border-radius:3px; border:1px solid #bbb; }

  .schedule-wrapper {
    margin-top: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: auto;          /* scrollable both ways */
    max-height: 70vh;        /* vertical scroll bound */
    max-width: 100%;
    position: relative;
  }
  .schedule-grid {
    display: grid;
    grid-template-columns:
      260px   /* sticky item name */
      140px   /* sticky quantity controls */
      repeat(<%= slots.size %>, 90px); /* each slot width */
    min-width: calc(260px + 140px + <%= slots.size %> * 90px);
  }
  .cell {
    padding: 10px;
    border-right: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
    background: #fff;
    font-size: 14px;
    line-height: 1.25;
    box-sizing: border-box;
  }
  .cell.sticky-1 { position: sticky; left: 0; background: #fafafa; font-weight: 600; z-index: 3; }
  .cell.sticky-2 { position: sticky; left: 260px; background: #fafafa; font-weight: 600; z-index: 3; border-left: 1px solid #e5e7eb; }
  .time-cell { text-align: center; font-weight: 700; background: #fafafa; position: sticky; top: 0; z-index: 2; font-size: 13px; }
  .corner { position: sticky; top: 0; left: 0; z-index: 4; background: #fafafa; font-weight:700; }
  .corner-2 { position: sticky; top: 0; left: 260px; z-index: 4; background: #fafafa; font-weight:700; }

  .slot {
    cursor: pointer;
    height: 34px;
    border-radius: 6px;
    margin: 8px;
    transition: transform 0.02s ease-in-out, background-color 0.15s ease-in-out;
    border: 1px solid #d1d5db;
  }

  /* meanings */
  .slot.available   { background: #22c55e33; }   /* green = available */
  .slot.unavailable { background: #ef444466; }   /* red   = already reserved / no capacity */
  .slot.selected    { background: #f59e0b66; }   /* orange = your selection */
  .slot.outside     { background: #9ca3af55; cursor: not-allowed; } /* gray = outside window */

  .slot:hover { transform: scale(1.02); }

  .item-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; }
  .qty-wrap { display:flex; align-items:center; gap:10px; }
  .qty-controls { display:inline-flex; flex-direction:column; gap:6px; }
  .qty-btn {
    width:30px; height:22px; line-height:20px; text-align:center;
    border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer;
    user-select:none; font-size:14px;
  }
  .qty-btn:disabled { opacity: 0.45; cursor: not-allowed; }
  .qty-display { font-weight:700; min-width: 1.8rem; text-align:center; font-size:15px; }
  .qty-cap { color:#6b7280; font-size: 12px; }

  .actions-bar { margin-top: 14px; display: flex; justify-content: flex-end; }
  .btn-primary {
    background: #111827; color: #fff; border: none;
    padding: 10px 16px; font-size: 15px; border-radius: 8px; cursor: pointer;
  }
  .btn-primary:hover { filter: brightness(1.05); }

  .owner-mode .slot { cursor: default; pointer-events: none; transform: none; }
  .owner-mode .slot:hover { transform: none; }

  .current-activity-section {
    margin: 2rem 0;
  }
  .current-activity-section h3 {
    margin-bottom: 0.75rem;
    font-size: 1.25rem; /* 20px */
  }
  .activity-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden; /* Ensures border-radius applies to corners */
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  }
  .activity-table th,
  .activity-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
  }
  .activity-table th {
    background-color: #fafafa;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    color: #374151;
  }
  .activity-table td {
    font-size: 14px;
    color: #111827;
  }
  .activity-table tbody tr:last-child td {
    border-bottom: none;
  }
  .current-activity-section p {
    color: #6b7280;
    font-style: italic;
    margin-top: 0.5rem;
  }
  .activity-table th:last-child,
  .activity-table td:last-child {
    text-align: center;
  }

  .activity-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .btn-action-warn {
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #d97706; /* amber-600 */
    color: #d97706;
    background: #fffbeb; /* amber-50 */
    border-radius: 6px;
    cursor: pointer;
  }
  .btn-action-warn:hover {
    background: #fef3c7; /* amber-100 */
  }

  .btn-action-revert {
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #52525b; /* zinc-600 */
    color: #3f3f46; /* zinc-700 */
    background: #f4f4f5; /* zinc-100 */
    border-radius: 6px;
    cursor: pointer;
  }
  .btn-action-revert:hover {
    background: #e4e4e7; /* zinc-200 */
  }
  .status-note {
    font-size: 11px;
    color: #6b7280; /* gray-500 */
    align-self: center;
    white-space: nowrap;
  }
  
  .status-note-complete {
    font-size: 12px;
    color: #16a34a; /* green-600 */
    font-weight: 500;
    align-self: center;
    white-space: nowrap;
    padding: 5px 0; /* Add padding to match button height */
  }

  /* Wrapper for the form and status text */
  .return-form-wrapper {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: center;
    /* Add a border to visually separate it */
    border-left: 2px solid #e5e7eb;
    padding-left: 8px;
    margin-left: 8px;
  }

  /* The form itself (input + button) */
  .return-form {
    display: flex;
    gap: 6px;
  }

  /* The small number input box */
  .return-input {
    width: 50px; 
    padding: 4px 6px;
    font-size: 13px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
  }
</style>

<div class="legend">
  <span class="key"><span class="swatch" style="background:#22c55e33;"></span>Available</span>
  <% unless is_owner %>
    <span class="key"><span class="swatch" style="background:#f59e0b66;"></span>Your Selection</span>
  <% end %>
  <span class="key"><span class="swatch" style="background:#ef444466;"></span>Unavailable</span>
</div>

<% if is_owner %>
  <div style="margin-bottom:1rem; text-align:right;">
    <%= link_to "Add Item", new_workspace_item_path(@workspace), class: "btn-primary" %>
  </div>
<% end %>

<div class="schedule-wrapper <%= 'owner-mode' if is_owner %>">
  <div class="schedule-grid" id="schedule-grid">
    <!-- Header -->
    <div class="cell corner sticky-1">Item</div>
    <div class="cell corner-2 sticky-2">Quantity</div>
    <% @slots.each do |slot| %>
      <div class="cell time-cell"><%= slot.strftime("%-I:%M%P") %></div>
    <% end %>

    <!-- Rows from backend availability -->
    <% @availability_data.each do |row| %>
      <% item = row[:item] %>
      <div class="cell sticky-1 item-name">
        <% if is_owner %>
          <%= link_to item.name, edit_workspace_item_path(@workspace, item), style: "text-decoration:none; color:#111827;" %>
        <% else %>
          <%= item.name %>
        <% end %>
      </div>

      <div class="cell sticky-2">
        <% if is_owner %>
          <span style="font-weight:600;"><%= item.quantity || 0 %></span>
        <% else %>
          <!-- NOTE: expose workspace id for cart payload -->
          <div class="qty-wrap" data-item-id="<%= item.id %>" data-workspace-id="<%= item.workspace_id %>">
            <div class="qty-controls">
              <button class="qty-btn qty-up" type="button" aria-label="Increase">▲</button>
              <button class="qty-btn qty-down" type="button" aria-label="Decrease">▼</button>
            </div>
            <span class="qty-display" data-count="0">0</span>
            <span class="qty-cap">/ <%= item.quantity || 0 %></span>
          </div>
        <% end %>
      </div>

      <% row[:slots].each do |s| %>
        <% klass =
            if !s[:within_window]
              'outside'                             # gray (outside window)
            elsif s[:available]
              'available'                           # green
            else
              'unavailable'                         # red (booked / no capacity)
            end
        %>
        <div class="cell" style="padding:0;">
          <div
            class="slot <%= klass %>"
            data-item-id="<%= item.id %>"
            data-start="<%= s[:start].iso8601 %>"
            data-end="<%= s[:end].iso8601 %>"
            data-within-window="<%= s[:within_window] %>"
            title="<%= "#{item.name} — #{s[:start].strftime('%-I:%M %p')}–#{s[:end].strftime('%-I:%M %p')}" %>"
          ></div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<% unless is_owner %>
  <div class="actions-bar">
    <button type="button" class="btn-primary" id="add-to-cart">Add to Cart</button>
  </div>
<% end %>

<hr>

<% if @current_join %>
  <% if @current_join.role == 'owner' %>
    <%= button_to "Delete This Workspace",
                  workspace_user_to_workspace_path(@workspace),
                  method: :delete,
                  class: "button-danger",
                  data: { confirm: "OWNER: Are you sure? This will permanently delete this workspace for ALL members." } %>
  <% else %>
    <%= button_to "Leave This Workspace",
                  workspace_user_to_workspace_path(@workspace),
                  method: :delete,
                  data: { confirm: "Are you sure you want to leave this workspace?" } %>
  <% end %>
<% else %>
  <%= button_to "Join Workspace as User",
                workspace_user_to_workspace_path(@workspace),
                method: :post %>
<% end %>

<br>

<script>
  (function () {
    const isOwner = <%= is_owner ? 'true' : 'false' %>;
    if (isOwner) return; // owners don't interact

    // Initialize quantity button disabled states
    document.querySelectorAll('.qty-wrap').forEach(wrap => {
      const capText = wrap.querySelector('.qty-cap')?.textContent || "/ 0";
      const cap = parseInt(capText.replace("/", "").trim(), 10) || 0;
      const upBtn = wrap.querySelector('.qty-up');
      const downBtn = wrap.querySelector('.qty-down');
      if (upBtn) upBtn.disabled = (cap <= 0);
      if (downBtn) downBtn.disabled = true;
    });

    document.addEventListener('click', function (e) {
      // Slot toggling
      const slot = e.target.closest('.slot');
      if (slot) {
        // block clicks on red (unavailable) and gray (outside)
        if (slot.classList.contains('unavailable') || slot.classList.contains('outside')) return;

        // toggle green <-> orange
        if (slot.classList.contains('available')) {
          slot.classList.remove('available');
          slot.classList.add('selected');
        } else if (slot.classList.contains('selected')) {
          slot.classList.remove('selected');
          slot.classList.add('available');
        }
        return;
      }

      // Quantity controls
      const up = e.target.closest('.qty-up');
      const down = e.target.closest('.qty-down');
      if (up || down) {
        const wrap = e.target.closest('.qty-wrap');
        if (!wrap) return;

        const itemId = wrap.dataset.itemId;
        const display = wrap.querySelector('.qty-display');
        const capText = wrap.querySelector('.qty-cap')?.textContent || "/ 0";
        const cap = parseInt(capText.replace("/", "").trim(), 10) || 0;

        let count = parseInt(display.dataset.count || "0", 10);
        if (up && count < cap) count += 1;
        if (down && count > 0) count -= 1;

        display.dataset.count = String(count);
        display.textContent = String(count);

        const upBtn = wrap.querySelector('.qty-up');
        const downBtn = wrap.querySelector('.qty-down');
        if (upBtn) upBtn.disabled = (count >= cap);
        if (downBtn) downBtn.disabled = (count <= 0);

        // Repaint this item's row based on backend availability for selected quantity
        fetch(`/reservations/availability?item_id=${encodeURIComponent(itemId)}&quantity=${encodeURIComponent(count)}`, {
          headers: { 'Accept': 'application/json' }
        })
          .then(r => r.json())
          .then(({ slots }) => {
            const rowSlots = document.querySelectorAll(`.slot[data-item-id="${itemId}"]`);
            const byStart = {};
            slots.forEach(s => { byStart[new Date(s.start).toISOString()] = s; });

            rowSlots.forEach(el => {
              const key = new Date(el.dataset.start).toISOString();
              const s = byStart[key];
              if (!s) return;

              const wasSelected = el.classList.contains('selected');

              el.classList.remove('available','selected','unavailable','outside');

              if (!s.within_window) {
                el.classList.add('outside');                   // gray
              } else if (s.available) {
                el.classList.add(wasSelected ? 'selected' : 'available'); // keep orange if user picked
              } else {
                el.classList.add('unavailable');               // red
              }
            });
          })
          .catch(() => { /* ignore for now */ });

        return;
      }

      // Add to Cart: collect selected slots and current quantity, then POST
      if (e.target.id === 'add-to-cart') {
        const selected = Array.from(document.querySelectorAll('.slot.selected'));
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (selected.length === 0) {
          alert('Select at least one time slot first.');
          return;
        }

        const selections = selected.map(el => {
          const itemId = parseInt(el.dataset.itemId, 10);
          const wrap = document.querySelector(`.qty-wrap[data-item-id="${itemId}"]`);
          const qty = wrap ? parseInt(wrap.querySelector('.qty-display')?.dataset.count || "1", 10) : 1;
          const workspaceId = wrap ? parseInt(wrap.dataset.workspaceId || "0", 10) : 0;

          return {
            item_id: itemId,
            workspace_id: workspaceId,
            start_time: el.dataset.start,
            end_time: el.dataset.end,
            quantity: qty || 1
          };
        });

        fetch('/cart_items', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'Accept': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ selections })
        })
          .then(r => r.json())
          .then(({ ok, total }) => {
            if (!ok) throw new Error('failed');

            // Clear selections back to "available"
            selected.forEach(el => {
              el.classList.remove('selected');
              el.classList.add('available');
            });

            // Update navbar "Cart (N)" if present
            const navLink = document.querySelector('a[href="/cart"]');
            if (navLink && typeof total === 'number') {
              navLink.textContent = `Cart (${total})`;
            }

            alert('Added to cart!');
          })
          .catch(() => alert('Something went wrong adding to the cart.'));

        return;
      }
    }, { passive: false });
  })();
</script>
