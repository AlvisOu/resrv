<h1>Your Cart</h1>

<% if @workspaces.blank? %>
  <p>No items yet. Go add some!</p>
<% else %>
  <div class="workspace-tabs" style="display:flex; gap:.5rem; margin-bottom:1rem;">
    <% @workspaces.each do |ws| %>
      <% active = (ws.id == @active_workspace_id) %>
      <%= link_to ws.name,
                  cart_path(workspace_id: ws.id),
                  class: "tab #{'active' if active}",
                  style: "padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:8px; #{'background:#111;color:#fff;' if active}" %>
    <% end %>
  </div>

  <% if @penalty %>
    <div class="alert alert-warning" style="background-color: #fef3c7; border: 1px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      ⚠️ You are blocked from making reservations in this workspace due to a <strong><%= @penalty.reason.humanize %></strong>.
      Access will be restored on <strong><%= @penalty.expires_at.strftime("%B %-d at %-I:%M %p") %></strong>.
      <% if @penalty.appeal_pending? %>
        <div style="margin-top:6px; color:#92400e;">Appeal submitted — waiting on owner review.</div>
      <% elsif @penalty.appeal_state == "resolved" %>
        <div style="margin-top:6px; color:#065f46;">Appeal reviewed by the workspace owner.</div>
      <% else %>
        <%= form_with url: appeal_penalty_path(@penalty), method: :post, local: true, style: "margin-top:8px; display:flex; flex-direction:column; gap:8px; max-width:480px;" do %>
          <%= text_field_tag :appeal_message, nil, placeholder: "Optional note to owner", class: "form-control form-control-sm", style: "width:100%;" %>
          <%= submit_tag "Appeal Penalty", class: "btn btn-sm btn-outline-dark", style: "align-self:flex-start; margin-top:6px;" %>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <% if @active_segments.blank? %>
    <p>No items in this workspace tab yet.</p>
  <% else %>
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th align="left">Item</th>
          <th align="left">Time</th>
          <th align="left">Qty</th>
        </tr>
      </thead>
        <tbody>
        <% @active_segments.each_with_index do |seg, i| %>
            <tr style="border-top:1px solid #eee;">
            <td><%= seg[:item]&.name || "(deleted item)" %></td>
            <td>
                <%= seg[:start_time]&.in_time_zone&.strftime("%b %-d, %-I:%M %p") %> –
                <%= seg[:end_time]&.in_time_zone&.strftime("%-I:%M %p") %>
            </td>
            <td><%= seg[:quantity] %></td>
            <td style="text-align:right;">
                <%= button_to "Remove",
                    remove_range_cart_items_path(
                        item_id:      seg[:item]&.id,
                        workspace_id: seg[:workspace]&.id,
                        start_time:   seg[:start_time]&.iso8601,
                        end_time:     seg[:end_time]&.iso8601
                    ),
                    method: :delete,
                    form: { data: { turbo_confirm: "Remove this time range from your cart?" } },
                    class: "btn btn-sm btn-outline-danger" %>
            </td>
            </tr>
        <% end %>
        </tbody>
    </table>

    <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:.5rem;">
    <%= form_with url: checkout_cart_path, method: :post, local: true, id: "checkout-form" do %>
        <%= hidden_field_tag :workspace_id, @active_workspace_id %>
        <% disabled = @penalty.present? %>
        <button type="submit"
                class="btn btn-primary"
                style="padding:.6rem 1rem; border-radius:8px; background:#111; color:#fff; border:none; opacity: <%= disabled ? 0.6 : 1 %>;"
                <%= "disabled" if disabled %>>
          <%= disabled ? "Blocked due to Penalty" : "resrv" %>
        </button>
    <% end %>
    <%= link_to "Continue Browsing", root_path, class: "btn" %>
    </div>
  <% end %>
<% end %>
