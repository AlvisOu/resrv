<div class="item-edit-shell">
  <div class="item-edit-left">
    <p class="eyebrow">Item</p>
    <h1 class="item-title"><%= @item.name %></h1>
    <p class="item-subtitle">Edit details and availability for <strong><%= @workspace.name %></strong>.</p>

    <%= render 'form' %>


  </div>

  <div class="item-edit-right">
    <div class="mini-card">
      <% if @busyness_index.present? %>
        <% if @busyness_index > 120 %>
          <p class="trend-badge busy">Busier than usual (<%= @busyness_index %>% of normal)</p>
        <% elsif @busyness_index < 80 %>
          <p class="trend-badge calm">Quieter than usual (<%= @busyness_index %>% of normal)</p>
        <% else %>
          <p class="trend-badge normal">About average activity (<%= @busyness_index %>% of normal)</p>
        <% end %>
      <% end %>
      <div class="chart-container">
        <canvas id="usageChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const ctx = document.getElementById("usageChart").getContext("2d");

    const hours = <%= raw @hours.map { |h| "#{h}:00" }.to_json %>;
    const avgCounts = <%= raw @avg_counts.values_at(*@hours).map { |v| v || 0 }.to_json %>;
    const currentCounts = <%= raw @current_counts.values_at(*@hours).map { |v| v || 0 }.to_json %>;
    const totalQuantity = <%= @total_quantity.to_json %>;

    new Chart(ctx, {
      data: {
        labels: hours,
        datasets: [
          {
            type: "bar",
            label: "Avg reservations (same weekday, past month)",
            data: avgCounts,
            backgroundColor: "rgba(54, 162, 235, 0.5)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          },
          {
            type: "line",
            label: "Today's reservations",
            data: currentCounts,
            borderColor: "rgba(255, 99, 132, 1)",
            backgroundColor: "rgba(255, 99, 132, 0.2)",
            borderWidth: 2,
            fill: false,
            tension: 0.3
          },
          {
            type: "line",
            label: "Total capacity",
            data: Array(hours.length).fill(totalQuantity),
            borderColor: "rgba(75, 192, 192, 1)",
            borderDash: [5, 5],
            borderWidth: 1.5,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: "Usage Trends â€” Hourly Reservations"
          },
          legend: {
            position: "bottom",
            labels: {
              usePointStyle: true,
              boxWidth: 12
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Reservations" }
          },
          x: {
            title: { display: true, text: "Hour of Day" }
          }
        }
      }
    });
  });
</script>


